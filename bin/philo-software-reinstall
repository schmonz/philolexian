#!/bin/sh -e

_VINTAGE=`date '+%Y%m%d'`
_PHILO=$HOME/philo
PKGSRCDIR=${_PHILO}/pkgsrc-current

philo_software_reinstall_bootstrap() {
	cd $PKGSRCDIR/bootstrap
	env SH=/bin/bash ./bootstrap --unprivileged --prefix=${_PHILO}/.pkg-${_VINTAGE} --pkgdbdir=${_PHILO}/.pkg-${_VINTAGE}/.pkgdb --varbase=${_PHILO}/var --sysconfdir=${_PHILO}/etc --prefer-pkgsrc=yes --abi=64
	./cleanup
}

philo_software_reinstall_build() {
	PATH=`echo $PATH | sed -e "s|/pkg/|/.pkg-${_VINTAGE}/|g"`
	cd ${_PHILO}/etc
	sed -e "s|^\(_VINTAGE=.*\)[0-9]\{8,\}|\1${_VINTAGE}|" < mk.conf > mk.conf.new && mv mk.conf.new mk.conf

	PHILO_PACKAGES='shlock tmux git vim nvi djbdns p5-Net-LibIDN p5-Math-BigInt-GMP p5-libwww p5-Math-BigInt-Pari p5-Net-OpenID-Consumer ikiwiki p5-HTML-Tree p5-DB_File p5-URI-Find graphviz keychain libgcrypt mp3splt normalize pkg_rolling-replace mr'
	for i in $PHILO_PACKAGES; do
		cd $PKGSRCDIR/*/$i && bmake package-install clean
	done
}

philo_software_reinstall_bless() {
	cd ${_PHILO} && rm pkg && ln -s .pkg-${_VINTAGE} pkg
}

philo_software_reinstall_print_start() {
	STARTTIME=`date`
	echo >&2 "Starting Philo software reinstall"
	echo >&2
}

philo_software_reinstall_print_finish() {
	FINISHTIME=`date`
	echo >&2 "Completed Philo software reinstall!"
	echo >&2 "Started:  $STARTTIME"
	echo >&2 "Finished: $FINISHTIME"
	echo >&2
}

main() {
	philo_software_reinstall_print_start
	philo_software_reinstall_bootstrap
	philo_software_reinstall_build
	philo_software_reinstall_bless
	philo_software_reinstall_print_finish
}

main "$@"
exit $?
